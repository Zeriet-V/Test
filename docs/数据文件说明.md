# 数据文件结构说明

## 两个文件的关系

```
response.jsonl (原始标注数据)
        ↓
    [数据预处理]
        ↓
test_response_label.jsonl (简化后的测试数据)
```

---

## 文件1: response.jsonl (原始数据)

### 字段结构
```json
{
  "id": "2",
  "source_id": "15592",
  "model": "mistral-7B-instruct",
  "temperature": 0.7,
  "labels": [                           ← 详细的标注数组
    {
      "start": 636,                     ← 幻觉文本的起始位置
      "end": 653,                       ← 幻觉文本的结束位置
      "text": "February 7, 2022.",      ← 具体的幻觉文本
      "meta": "EVIDENT CONFLICT...",    ← 标注说明
      "label_type": "Evident Conflict", ← 幻觉类型
      "implicit_true": false,
      "due_to_null": false
    },
    {
      "start": 871,
      "end": 969,
      "text": "has prompted the Anne Frank House...",
      "meta": "HIGH INTRODUCTION OF NEW INFORMATION...",
      "label_type": "Evident Baseless Info",
      ...
    },
    {
      "start": 607,
      "end": 646,
      "text": "believed to have died before February 7",
      "meta": "EVIDENT CONFLICT...",
      "label_type": "Evident Conflict",
      ...
    }
  ],
  "split": "train",
  "quality": "good",
  "response": "New research conducted by..."
}
```

### 特点
- ✅ 包含幻觉的**精确位置**（字符级别）
- ✅ 包含幻觉的**具体文本**
- ✅ 包含详细的**标注说明**
- ✅ 一个响应可能有**多个标注**（labels是数组）

---

## 文件2: test_response_label.jsonl (简化数据)

### 字段结构
```json
{
  "id": "2",
  "source_id": "15592",
  "task_type": "Summary",
  "test": "Seventy years ago, Anne Frank died...",
  "response": "New research conducted by...",
  "label_types": [                      ← 只保留幻觉类型
    "Evident Conflict",
    "Evident Baseless Info",
    "Evident Conflict"
  ]
}
```

### 特点
- ✅ 简化为**幻觉检测**所需的最少信息
- ✅ 去掉了位置、文本等细节
- ✅ 增加了 `task_type` 字段（任务类型）
- ✅ 增加了 `test` 字段（原文/测试输入）

---

## 为什么一个数据有多个 label_type？

### 原因：一个生成的响应可能包含多处幻觉

### 实际案例（ID=2）

**生成的响应（970字符）中有3处幻觉：**

#### 幻觉1: 日期错误（位置636-653）
```
文本: "February 7, 2022."
类型: Evident Conflict
说明: 原文是 1945年，生成错误写成 2022年
```

#### 幻觉2: 凭空编造（位置871-969）
```
文本: "has prompted the Anne Frank House to issue a corrected statement..."
类型: Evident Baseless Info
说明: 原文中完全没有提到这个信息
```

#### 幻觉3: 日期模糊（位置607-646）
```
文本: "believed to have died before February 7"
类型: Evident Conflict
说明: 原文说日期不确定，生成却给出明确日期
```

**结果：**
```python
label_types = [
    'Evident Conflict',        # 对应幻觉1
    'Evident Baseless Info',   # 对应幻觉2
    'Evident Conflict'         # 对应幻觉3
]
```

---

## 数据统计

| 类别 | 数量 | 比例 |
|------|------|------|
| **总数据量** | 17,790 | 100% |
| 无幻觉 | 10,126 | 56.9% |
| 单个幻觉 | 4,138 | 23.3% |
| **多个幻觉** | **3,526** | **19.8%** |
| 最多幻觉数 | 14 | - |

### 关键发现
- 📊 **近20%的有幻觉数据包含多处幻觉**
- 📊 最极端的样本包含**14处幻觉**
- 📊 平均每个有幻觉的样本包含 **1.8个幻觉**

---

## 为什么在 response.jsonl 中你"没有发现"label_type？

### 可能的原因

#### 1. 查看了无幻觉的数据
```json
{
  "id": "0",
  "labels": [],  ← 空数组，无幻觉
  ...
}
```

#### 2. labels 是数组，需要展开查看
```json
{
  "labels": [
    {
      "label_type": "Evident Conflict",  ← 在这里！
      ...
    }
  ]
}
```

#### 3. 文件太长，内容被截断
- response.jsonl 每行都很长（2000-4000字符）
- IDE可能没有显示完整的JSON结构

---

## 数据转换过程（推测）

可能存在一个预处理脚本：

```python
def convert_response_to_test(response_file, test_file):
    """
    将 response.jsonl 转换为 test_response_label.jsonl
    """
    with open(response_file, 'r') as f_in, \
         open(test_file, 'w') as f_out:
        
        for line in f_in:
            data = json.loads(line)
            
            # 提取 label_types
            label_types = [
                label['label_type'] 
                for label in data.get('labels', [])
            ]
            
            # 构建新格式
            new_data = {
                'id': data['id'],
                'source_id': data['source_id'],
                'task_type': infer_task_type(data),  # 根据source推断
                'test': get_test_content(data),      # 获取原文
                'response': data['response'],
                'label_types': label_types
            }
            
            f_out.write(json.dumps(new_data) + '\n')
```

---

## 使用场景

### response.jsonl
- 📝 **标注研究**：分析幻觉的具体位置和内容
- 📝 **质量评估**：检查标注的准确性
- 📝 **详细分析**：理解每个幻觉的具体表现

### test_response_label.jsonl
- 🔍 **幻觉检测**：训练/测试检测模型
- 🔍 **性能评估**：计算准确率、召回率
- 🔍 **快速筛选**：按幻觉类型过滤数据

---

## 总结

### 核心区别
| 特性 | response.jsonl | test_response_label.jsonl |
|------|----------------|---------------------------|
| **用途** | 标注存储 | 模型测试 |
| **幻觉信息** | 详细（位置+文本+说明） | 简化（只有类型） |
| **文件大小** | 较大 | 较小 |
| **易读性** | 复杂 | 简单 |

### 为什么有多个label_type？
**因为一个AI生成的响应可能在多处存在不同类型的幻觉！**

这是真实世界的情况：
- 一个句子可能有事实错误（Conflict）
- 另一个句子可能是凭空编造（Baseless）
- 同一个响应中可能同时存在多种幻觉

数据集忠实记录了这种复杂性。
