# BARTScore 误判样本分析说明

## 📊 修改内容

### 1. 移除自动阈值功能
- 删除了 `auto_threshold` 参数
- 删除了 `threshold_sample_size` 参数
- 删除了对 `threshold_optimizer` 的依赖
- 固定使用阈值：**-1.8649**（基于1000样本分析得出的最优F1阈值）

### 2. 新增误判样本统计

在检测报告中新增了详细的误判分析部分，包括：

#### 假阳性（False Positive）分析
- **定义**：无幻觉但被误判为幻觉的样本
- **统计内容**：
  - 总数和占比
  - 按任务类型分布（Summary、QA、Data2txt）
  - 前10个误判样本示例（包含ID、任务类型、BARTScore分数）

#### 假阴性（False Negative）分析
- **定义**：有幻觉但未被检测的样本
- **统计内容**：
  - 总数和占比
  - 按任务类型分布
  - 按幻觉标签类型分布（Evident Conflict、Subtle Conflict等）
  - 前10个漏检样本示例（包含ID、任务类型、标签类型、分数）

#### 误判模式总结
- 误判总数统计
- 假阳性和假阴性占比对比
- 主要问题识别和改进建议

---

## 📝 报告输出示例

运行后会在 `bartscore_results_report.txt` 中看到类似内容：

```
================================================================================
【误判样本详细分析】
================================================================================

◆ 假阳性 (False Positive) - 无幻觉但被误判为幻觉
  总数: 2456 / 2456 

  按任务类型分布:
    Summary: 1234 (50.24%)
    QA: 789 (32.13%)
    Data2txt: 433 (17.63%)

  假阳性样本示例 (前10个):
    1. ID: 1234, 任务: Summary, 分数: -2.1234
    2. ID: 5678, 任务: QA, 分数: -1.9876
    ...

◆ 假阴性 (False Negative) - 有幻觉但未被检测
  总数: 521 / 521

  按任务类型分布:
    Summary: 312 (59.88%)
    QA: 156 (29.94%)
    Data2txt: 53 (10.17%)

  按幻觉标签类型分布:
    Subtle Conflict: 234 (44.91%)
    Subtle Baseless Info: 178 (34.16%)
    Evident Conflict: 67 (12.86%)
    Evident Baseless Info: 42 (8.06%)

  假阴性样本示例 (前10个):
    1. ID: 2345, 任务: Summary, 标签: [Subtle Conflict], 分数: -1.6543
    2. ID: 6789, 任务: QA, 标签: [Subtle Baseless Info], 分数: -1.7234
    ...

【误判模式总结】
  误判总数: 2977
  假阳性占比: 82.50%
  假阴性占比: 17.50%

  主要问题: 假阳性过多（误报）
  建议: 降低阈值（更负），提高检测严格度
```

---

## 🔍 分析用途

### 1. 识别问题任务类型
通过任务类型分布，可以看出：
- 哪种任务类型最容易误报（假阳性）
- 哪种任务类型最容易漏检（假阴性）
- 是否需要针对不同任务类型使用不同阈值

### 2. 识别难检测的幻觉类型
通过幻觉标签分布，可以看出：
- 哪种类型的幻觉最容易被漏检
- Subtle（微妙）类型是否比Evident（明显）类型更难检测
- Conflict（冲突）和Baseless Info（无依据）哪种更难检测

### 3. 优化阈值策略
根据假阳性和假阴性的占比：
- **假阳性过多**：阈值太高（太接近0），需要降低阈值（更负）
- **假阴性过多**：阈值太低（太负），需要提高阈值（更接近0）
- **两者平衡**：当前阈值较为合理

### 4. 查看具体样本
可以根据报告中的样本ID，在原始数据中找到对应样本：
- 分析为什么会误判
- 查看文本特征
- 改进检测策略

---

## 🎯 使用建议

### 步骤1: 运行检测
```bash
cd detectors
python bartscore_detector.py
```

### 步骤2: 查看报告
打开 `bartscore_results_report.txt`，重点关注：
- 【误判样本详细分析】部分
- 假阳性和假阴性的任务类型分布
- 误判模式总结的建议

### 步骤3: 分析误判样本
根据报告中的样本ID，在数据文件中查找具体样本：
```python
import json

# 读取原始数据
with open('../data/test_response_label.jsonl', 'r', encoding='utf-8') as f:
    for line in f:
        data = json.loads(line)
        if data['id'] == '1234':  # 替换为报告中的ID
            print(data)
            break
```

### 步骤4: 优化策略
根据分析结果：

1. **如果假阳性过多（当前情况）**：
   - 降低阈值到 -2.0、-2.3 或 -2.5
   - 重新运行检测
   - 对比误判情况

2. **如果某个任务类型误判特别多**：
   - 考虑针对该任务类型单独设置阈值
   - 或者改进该任务类型的文本预处理

3. **如果某种幻觉标签漏检严重**：
   - 考虑结合其他检测方法（如N-gram、Spacy）
   - 针对该类型幻觉设计专门的检测规则

---

## 📈 预期分析结果

基于阈值 -1.8649，预期会看到：

### 假阳性（误报）
- **预期占比**：约82%的误判来自假阳性
- **主要任务类型**：Summary任务可能占比最高
- **原因**：阈值偏高，很多无幻觉样本的分数也低于阈值

### 假阴性（漏检）
- **预期占比**：约18%的误判来自假阴性
- **主要标签类型**：Subtle类型（微妙幻觉）可能占比最高
- **原因**：微妙的幻觉与原文相似度较高，BARTScore分数不够低

---

## 🛠️ 后续优化方向

1. **调整阈值**
   - 根据误判分析结果，尝试阈值 -2.0、-2.3、-2.5
   - 比较不同阈值下的误判模式

2. **分任务优化**
   - 为不同任务类型设置不同阈值
   - 例如：Summary用-2.0，QA用-2.5，Data2txt用-2.2

3. **组合检测**
   - BARTScore + N-gram + Spacy
   - 加权融合多种方法的结果

4. **特征工程**
   - 分析误判样本的文本特征
   - 添加额外的检测规则






