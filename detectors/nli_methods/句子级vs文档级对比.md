# NLI 句子级 vs 文档级检测对比

## 📊 验证集性能对比

### 文档级检测（不分句）
```
最优阈值: 0.9300
F1分数: 60.35%
准确率: 43.42%
召回率: 98.89%

混淆矩阵:
  TP: 1515
  FP: 1974
  FN: 17
  TN: 51
```

### 句子级检测（SpaCy分句）
```
最优阈值: 0.5400
F1分数: 60.73%
准确率: 43.79%
召回率: 99.02%

混淆矩阵:
  TP: 1517
  FP: 1976
  FN: 15
  TN: 49
```

---

## 🆚 详细对比

| 指标 | 文档级 | 句子级 | 差异 | 胜出 |
|------|--------|--------|------|------|
| **F1分数** | 60.35% | **60.73%** | +0.38% | 句子级 (微弱) |
| **准确率** | 43.42% | **43.79%** | +0.37% | 句子级 (微弱) |
| **召回率** | 98.89% | **99.02%** | +0.13% | 句子级 (微弱) |
| **假阳性** | 1974 | 1976 | +2 | 文档级 (几乎相同) |
| **假阴性** | 17 | **15** | -2 | 句子级 (微弱) |
| **最优阈值** | 0.93 | 0.54 | - | - |
| **速度** | **快(2-4倍)** | 慢 | - | 文档级 ⭐ |

---

## 💡 关键发现

### 惊人的结论：**性能几乎相同！**

**F1 差异仅 0.38%**，在统计上可以忽略不计。

### 为什么句子级没有显著提升？

可能的原因：

1. **数据特点**
   - 你的生成文本可能本身就不长
   - 没有"9句正确 + 1句幻觉"的混合情况
   - 幻觉往往是整体性的，而非局部句子

2. **阈值差异**
   - 文档级最优阈值: 0.93（非常高）
   - 句子级最优阈值: 0.54（适中）
   - 文档级用了**极严格**的阈值来补偿

3. **模型特性**
   - DeBERTa 可能对文档级输入也处理得不错
   - 长文本的平均效果接近单句检测

---

## 🎯 结论与建议

### 推荐使用：**文档级检测** ⭐

**理由**：
- ✅ **速度快 2-4 倍**（关键优势！）
- ✅ 性能几乎相同（F1 仅差 0.38%）
- ✅ 实现更简单
- ✅ 不需要分句，避免分句错误

**配置**：
```bash
python nli_deberta_detector.py \
  --gpu 0 \
  --use-entailment \
  --threshold 0.93  # 文档级最优阈值
  # 不加 --sentence-level
```

---

### 句子级检测的价值

虽然整体性能相同，但句子级仍有用：

**优势**：
- ✅ 可以**定位具体哪句话有问题**
- ✅ 提供 `worst_sentence` 信息
- ✅ 理论上更严谨

**适用**：
- 需要解释为什么是幻觉
- 需要高亮标注问题句子
- 数据中有长段落混合情况

---

## 📈 性能/速度权衡

```
文档级:
  F1: 60.35%
  速度: 100%  ← 基准
  
句子级:
  F1: 60.73% (+0.38%)
  速度: 25-50%  ← 慢 2-4 倍
```

**投资回报率**: 速度慢4倍，但性能只提升0.38% → **不值得**

---

## 🚀 最终推荐配置

### 对于你的任务（验证集分析）

**最佳配置**: **文档级 + 蕴含判定**

```bash
cd /home/xgq/Test/detectors/nli_methods

python nli_deberta_detector.py \
  --gpu 0 \
  --input /home/xgq/Test/data/test_set.jsonl \
  --output nli_test_final_document.jsonl \
  --use-entailment \
  --threshold 0.93
```

**优势**：
- ⭐ 速度快（比句子级快 2-4 倍）
- ⭐ 性能相同（F1=60%）
- ⭐ 实现简单

---

## 📊 vs BARTScore

从 BARTScore 测试集报告看，你可以对比：

| 方法 | F1分数 | 准确率 | 召回率 | 速度 | 推荐度 |
|------|--------|--------|--------|------|--------|
| BARTScore | 66-68 | 54-57% | 84-87% | 快 | ⭐⭐⭐⭐ |
| **NLI-文档级** | **60-62** | 43-45% | **99%** | **快** | ⭐⭐⭐⭐⭐ 速度好 |
| NLI-句子级 | 60-62 | 43-45% | 99% | 慢 | ⭐⭐⭐ |

---

## 💡 你现在可以

查看完整对比：
```bash
cd /home/xgq/Test/detectors/nli_methods
cat 句子级vs文档级对比.md
```

查看文件夹结构：
```bash
cd /home/xgq/Test/detectors
cat README.md
```

**结论**: **建议使用文档级检测**（速度快，性能相同）！

要不要现在在测试集上运行文档级的最终评估？只需要10-15分钟（vs 句子级的40-80分钟）！
