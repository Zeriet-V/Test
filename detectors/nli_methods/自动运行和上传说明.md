# 检索增强 NLI 自动运行和上传

## 🚀 一键运行（推荐）

### 方法1：Python 脚本（推荐）

```bash
cd /home/xgq/Test/detectors/nli_methods
python3 run_retrieval_and_upload.py
```

### 方法2：Shell 脚本

```bash
cd /home/xgq/Test/detectors/nli_methods
bash run_retrieval_and_upload.sh
```

## ⏱️ 运行时间

- **检测阶段**: 3-4 小时
- **上传阶段**: 1-2 分钟
- **总耗时**: 约 3-4 小时

## 📋 执行流程

### 步骤 1/3：运行检索增强 NLI 检测

自动执行：
```bash
python3 nli_retrieval_detector.py \
  --gpu 1 \
  --input /home/xgq/Test/data/validation_set.jsonl \
  --output nli_retrieval_validation_results.jsonl \
  --use-entailment \
  --sentence-level \
  --threshold-entail 0.45 \
  --threshold-contra 0.2 \
  --top-k 3
```

**输出文件**：
- `nli_retrieval_validation_results.jsonl` - 详细结果
- `nli_retrieval_validation_results_report.txt` - 统计报告

### 步骤 2/3：检查结果文件

自动检查：
- ✓ 结果文件是否生成
- ✓ 报告文件是否生成
- ✓ 显示性能摘要（F1/Precision/Recall）

### 步骤 3/3：上传到 GitHub

自动执行：
```bash
cd /home/xgq/Test

# 添加文件
git add detectors/nli_methods/nli_retrieval_validation_results.jsonl
git add detectors/nli_methods/nli_retrieval_validation_results_report.txt
git add detectors/nli_methods/nli_retrieval_detector.py
git add detectors/nli_methods/检索增强NLI使用说明.md
git add docs/BARTScore_NLI_综合报告.md

# 提交
git commit -m "添加检索增强NLI验证集结果 - Top-K=3"

# 推送
git push
```

## 📥 本地查看结果

运行完成并上传后，在你的本地电脑：

```bash
cd /path/to/your/local/Test

# 拉取最新代码
git pull

# 查看报告
cat detectors/nli_methods/nli_retrieval_validation_results_report.txt

# 或在编辑器中打开
code detectors/nli_methods/nli_retrieval_validation_results_report.txt
```

## ⚠️ 注意事项

### 1. 确保 Git 配置正确

首次使用前，确保：
```bash
cd /home/xgq/Test
git config user.name "Your Name"
git config user.email "your.email@example.com"
```

### 2. 如果推送失败

脚本会提示推送失败，你需要手动执行：
```bash
cd /home/xgq/Test
git push origin main  # 或 master
```

可能的原因：
- 需要认证（GitHub token）
- 远程仓库有更新（需要先 pull）
- 网络问题

### 3. 后台运行（推荐）

如果想在后台运行并记录日志：

```bash
cd /home/xgq/Test/detectors/nli_methods

# 后台运行，输出到日志文件
nohup python3 run_retrieval_and_upload.py > retrieval_run.log 2>&1 &

# 查看进程
ps aux | grep run_retrieval_and_upload

# 实时查看日志
tail -f retrieval_run.log

# 查看 GPU 使用情况
watch -n 1 nvidia-smi
```

## 📊 运行完成后

### 自动生成的文件

1. **nli_retrieval_validation_results.jsonl** - 每个样本的详细结果
2. **nli_retrieval_validation_results_report.txt** - 统计报告（格式与标准 NLI 相同）

### 对比分析

运行完成后，可以对比：

| 方法 | 报告文件 | F1 | Precision | Recall |
|------|---------|-----|-----------|---------|
| 标准 NLI | `nli_validation_fixed_cpu_report.txt` | 62.06 | 45.70% | 96.67% |
| 检索增强 NLI | `nli_retrieval_validation_results_report.txt` | ? | ? | ? |

查看检索增强是否带来性能提升！

## 🔧 故障排查

### 如果检测阶段失败

```bash
# 检查错误日志
cat retrieval_run.log

# 手动运行检测
python3 nli_retrieval_detector.py --gpu 1 \
  --input /home/xgq/Test/data/validation_set.jsonl \
  --output nli_retrieval_validation_results.jsonl
```

### 如果上传阶段失败

```bash
cd /home/xgq/Test

# 手动上传
git add detectors/nli_methods/nli_retrieval_validation_results*
git commit -m "添加检索增强NLI结果"
git push
```

## 💡 使用建议

1. **后台运行**：用 `nohup` 后台运行，避免终端断开导致中断
2. **监控进度**：用 `tail -f retrieval_run.log` 实时查看进度
3. **检查 GPU**：用 `nvidia-smi` 确认 GPU 1 在运行
4. **预留时间**：至少预留 4-5 小时

